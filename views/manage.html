<!doctype html>
<html lang="en-US">

<head>
    <meta charset='utf-8'>
    <!--
         Todo:
        1. SEO meta tags to improve search results.
        2. ONe page app
    -->
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Certlify</title>
    <meta name="msapplication-tap-highlight" , content="none" />
    <!-- <link rel="manifest" href="manifest.json"> -->

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Certlify">
    <meta name="apple-mobile-web-app-title" content="Certlify">
    <meta name="theme-color" content="#34495E">
    <meta name="msapplication-navbutton-color" content="#FF9800">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="msapplication-starturl" content="index.html">
    <link rel="icon" sizes="128x128" href="">
    <link rel="apple-touch-icon" sizes="128x128" href="">
    <link rel="icon" sizes="192x192" href="">
    <link rel="apple-touch-icon" sizes="192x192" href="">
    <link rel="icon" sizes="256x256" href="">
    <link rel="apple-touch-icon" sizes="256x256" href="">
    <link rel="icon" sizes="384x384" href="">
    <link rel="apple-touch-icon" sizes="384x384" href="">
    <link rel="icon" sizes="512x512" href="/imgs/icon.png">
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='/src/css/manage.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='/src/css/animations.css'>
    <link rel='stylesheet' type='text/css' media='screen' href='/src/css/loader.css' />
</head>

<body>
    <header>
        <section class="logo-section">
            <span class="code-logo"><img class="cropped-logo" src="/imgs/code logo.jpg" alt="logo icon"></span>
            <div class="img-line"></div>
        </section>

        <span id="profile-image"><img id="user-image" src="/imgs/user.svg" alt="user icon" /></span>

        <section class="search-section">
            <input type="search" placeholder="Search" />
            <button onclick=""><img src="/imgs/search.svg" alt=""></button>
        </section>

        <input type="checkbox" id="toggle-butt" />

        <label for="toggle-butt" class="bread-crumbs">
            <div class="bread-crumb"></div>
            <div class="bread-crumb"></div>
            <div class="bread-crumb"></div>
        </label>

        <nav class="section-links">
            <ul class="home-links">
                <li><a href="/">Home</a>
                </li>
                <li class="gen-cert"><a href="/dashboard">Issued Certificates</a>
                    <hr class="active-cert">
                </li>
            </ul>
        </nav>

        <section class="volunteer-header">
            <h1 id="title"></h1>
            
            <a href="/dashboard" id="back-button"><img src="/imgs/arrow.svg" alt="back to dashboard"></a>
        </section>
    </header>

    <main class="main-dashboard">
        <section class="cert-section">
            <img id="template" alt="certificate template" />
        </section>

        <section class="edit-section">
            <a href="">Upload CSV</a>
            <a onclick="ToggleModal();ShowLoader();">Collectors</a>
            <a href="/createcertificate">Add Certificate</a>
        </section>
    </main>
    <span class="loader">
        <div class="container-for-loader">
            <div class="large-circle">
            </div>
            <div class="inner-circle"></div>
            <div class="inner-circle"></div>
            <div class="inner-circle"></div>
            <div class="inner-circle"></div>
        </div>
    </span>

    <section aria-live="polite" class="collectors-modal hide">
        <section class="collectors-panel">
            <span class="table-header">
                <a onclick="ToggleModal()" id="close-button">&#x2716;</a>
                <h3>Collectors</h3>
            </span>
            <section class="table-section">
                <table id="collectors">
                    <tr>
                        <th>S/N</th>
                        <th>Name on Certificate</th>
                        <th>Email Address</th>
                        <th>Status</th>
                    </tr>
                </table>
            </section>
        </section>
    </section>

    <script src='/src/js/main.js'></script>
    <script>
        // This function parses the link variable in the query string in the url. The string stored by it is needed to make the api request for the properties of the certificate
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            console.log('Query variable %s not found', variable);
        }
    </script>
    <script>
        ShowLoader();
        // parsing the link variable
        let link = getQueryVariable("link")
        // variable for sharable link;
        let ShareLink;
        // Making a XHR request for the name and image source at the api endpoint
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", `/api/manage/${link}/details`, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.onreadystatechange = function () {
            // When the response is recieved and the status code is 200
            if (this.readyState == 4 && this.status == 200) {
                // parse the data
                let data = JSON.parse(this.responseText)
                // The data has the name property for the name of the certificate and the src property for the src of the certificate;
                document.getElementById("title").innerHTML = data.name;
                document.getElementById("template").src = data.src;
                ShareLink=data.share;
                HideLoader();
            }
        };

        xhttp.send();

       
    </script>
<script>
    // another XHR request 
            var xhttp2 = new XMLHttpRequest();
            xhttp2.open("GET", `/api/manage/${link}/getcollectors`, true);
            xhttp2.setRequestHeader("Content-Type", "application/json");
            xhttp2.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let data = JSON.parse(this.responseText)
                    let collectors = data.collectors;
                    for (i in collectors) {
                        let collected;
                        let style;
                        if (collectors[i].status) {
                            collected = "Collected"
                            style="style='color:green'"
                        } else {
                            collected = "Not Collected"
                             style="style='color:red'"
                        }
                        document.getElementById("collectors").innerHTML += `
                        <tr>
                    <td>${Number(i) + 1}</td>
                    <td>${collectors[i].name || ""}</td>
                    <td>${collectors[i].email}</td>
                    <td class="collected-status"${style}>${collected}</td>
                </tr>
                
                        `
                    }
                    HideLoader();
                }
            };

            xhttp2.send();
</script>
</body>

</html>